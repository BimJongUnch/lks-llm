service: lks
provider:
   name: aws
   runtime: nodejs20.x
   region: us-east-1
   # stage: ${opt:prod, 'dev'}
   vpc:
      securityGroupIds:
         - sgr-04ad651354852bf8a
      subnetIds:
         - subnet-05e3eede547f32cd6

package:
   individually: true
   patterns:
      - src/**
      - "!src/layers/**"

functions:
   Chat:
      handler: src/functions/chat.mjs:handler
      name: lks-chat
      timeout: 5
      memorySize: 128
      ephemeralStorageSize: 512
      role: !Sub arn:aws:iam::${AWS::AccountId}:role/LabRole
      vpc: ~
      events:
         - http:
               path: /chat
               method: post
               private: true
               integration: lambda-proxy
      layers:
         - !Ref LKSChatLayer
      package:
         patterns:
            - "!src/**"
            - src/functions/chat.mjs
      environment:
         OLLAMA_BASE_URL: "https://172.31.22.27:11434"

   Assess:
      handler: src/functions/assess.mjs:handler
      name: lks-assess
      timeout: 5
      memorySize: 128
      ephemeralStorageSize: 512
      role: !Sub arn:aws:iam::${AWS::AccountId}:role/LabRole
      vpc: ~
      events:
         - http:
               path: /chat
               method: post
               private: true
               integration: lambda-proxy
      layers:
         - !Ref LKSChatLayer
      package:
         patterns:
            - "!src/**"
            - src/functions/chat.mjs
      environment:
         OLLAMA_BASE_URL: "https://172.31.22.27:11434"

layers:
   LKSChatLayer: 
      path: src/layers/chat-layer
      description: Common utilities and libraries
      compatibleRuntimes:
         - nodejs20.x
